// src/pages/AddRecipe.tsx

import React from "react";
import { useRef } from 'react';
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import './AddRecipe.css';
import { recipeService } from "../../services/recipeService";
import { useAuth } from "../../contexts/AuthContext"; 
//import type { UserData } from "../../services/api"; // [FIX] ‡πÉ‡∏ä‡πâ type-only import

export default function AddRecipe() {
    const navigate = useNavigate();
    // [FIX] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô return (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î warning)
    const fileInputRef = useRef<HTMLInputElement>(null); 
    const { user } = useAuth();

    const [ formData, setFormData] = useState({
        name: '',
        category: '',
        ingredients: '',
        steps: ''
    });
    // [FIX] ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î warning)
    const [ image, setImage ] = useState<string | null>(null);
    const [ isUploading, setIsUploading ] = useState(false);

    const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            setIsUploading(true);
            const reader = new FileReader();
            reader.onloadend = () => {
                setImage(reader.result as string);
                setIsUploading(false);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
        setFormData({
            ...formData,
            [e.target.name]: e.target.value
        });
    };

    const resizeImage = (file: File, maxWidth: number, maxHeight: number): Promise<string> => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx?.drawImage(img, 0, 0, width, height);

                    //‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô  base64 ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 0.8
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
                img.src = e.target?.result as string;
            };
            reader.readAsDataURL(file);
        });
    }

    const handleImageClick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = async (e: Event) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (file) {
                setIsUploading(true);
                try {
                    const dataUrl = await resizeImage(file, 800, 800);
                    setImage(dataUrl);
                } catch (error) {
                    console.error('Error resizing image:', error);
                    //fallback
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        setImage(event.target?.result as string);
                    };
                    reader.readAsDataURL(file);
                } finally {
                    setIsUploading(false);
                }
            }
        };
        input.click();
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
        if (!user || !user.id) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
            navigate('/login');
            return;
        }

        // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô Submit
        if (!formData.name || !formData.ingredients || !formData.steps) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô')
            return;
        }
        
        // 3. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á API
        const newRecipe = {
            title: formData.name,
            description: `‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${formData.category}\n\n‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°:\n${formData.ingredients}\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥:\n${formData.steps}`,
            image: image || '',
            userId: user.id, 
        };

       try {
        // üîë FIX: ‡∏•‡∏ö 'as any' ‡∏≠‡∏≠‡∏Å ‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î Type ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ó‡∏≥‡πÑ‡∏î‡πâ)
        // ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡πâ recipeService.addRecipe ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô type ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const createdRecipe = await recipeService.addRecipe(newRecipe); // <-- ‡∏•‡∏ö as any

        console.log('New Recipe Created:', createdRecipe);
            
            // 5. ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Home ‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Refresh
            navigate('/', { state: { refresh: Date.now() } });
        } catch (error) {
            console.error('Error adding recipe:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÑ‡∏î‡πâ: ' + (error as Error).message);
        }
    };


    return (
    <div className="add-page">
        <div className="Addpage-container">
            {/* Header */}
            {/* <Header /> */}

            {/* Back Button */}
            <button className="back-button" onClick={() => navigate(-1)}>
                ‚Üê Back
            </button>

            {/* Form - ‡πÄ‡∏û‡∏¥‡πà‡∏° <form> tag ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */}
            <form className="form-container" onSubmit={handleSubmit}>
                {/* Image Upload */}
                <div 
                    className={`image-upload ${image ? 'has-image' : ''}`}
                    onClick={handleImageClick}
                >
                    {isUploading ? (
                        <div className="upload-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î...</div>
                    ) : image ? (
                        <>
                            <img src={image} alt="preview" className="uploaded-image" />
                            <div className="image-info">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ</div>
                        </>
                    ) : (
                        <>
                            <div className="upload-icon">+</div>
                            <div className="upload-text">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>
                        </>
                    )}
                </div>

                {/* Input file ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ */}
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleImageChange}
                    accept="image/*"
                    style={{ display: 'none' }}
                />

                {/* ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£ */}
                <div className="form-group">
                    <label className="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</label>
                    <input
                        type="text"
                        name="name"
                        className="form-input"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£"
                        value={formData.name}
                        onChange={handleInputChange}
                    />
                </div>

                {/* ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */}
                <div className="form-group">
                    <label className="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <input
                        type="text"
                        name="category"
                        className="form-input"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó"
                        value={formData.category}
                        onChange={handleInputChange}
                    />
                </div>

                {/* ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö */}
                <div className="form-group">
                    <label className="form-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                    <textarea
                        name="ingredients"
                        className="form-input form-textarea"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö"
                        value={formData.ingredients}
                        onChange={handleInputChange}
                    />
                </div>

                {/* ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥ */}
                <div className="form-group">
                    <label className="form-label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥</label>
                    <textarea
                        name="steps"
                        className="form-input form-textarea"
                        placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥"
                        value={formData.steps}
                        onChange={handleInputChange}
                    />
                </div>

                {/* Submit Button - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô type="submit" */}
                <button type="submit" className="submit-button">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                </button>
            </form>
        </div>
    </div>
)
}